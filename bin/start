#!/usr/bin/env ruby
$PROGRAM_NAME='weeknoteabot'
$stdout.sync = true

require 'thread'

require 'bundler/setup'
require 'mail'
require 'logger'

$:.unshift('./lib')
require 'mailer'
require 'message_parser'
require 'weeknote_state'

config_file = File.expand_path('../config.yml', File.dirname(__FILE__))

begin
  email_config = YAML::load_file(config_file)
rescue Errno::ENOENT => e
  abort "config.yml not found. Use rake config to generate one."
end

Mail.defaults do
  retriever_method :imap, email_config
end

@state         = WeeknoteState.new
@incoming_mail = Queue.new
@outgoing_mail = Queue.new
@threads       = []
@logger        = Logger.new(STDOUT)


Thread.abort_on_exception = true
@threads << Thread.new do
  loop do
    Mailer.check_for_new_email do |email|
      @logger.info "Found new email #{email.subject}"
      @incoming_mail << email
    end
    sleep(10)
  end
end

@threads << Thread.new do
  loop do
    email = @incoming_mail.pop
    @logger.info "Recieved email #{email.subject} for processing"
    msg = MessageParser.new(email, @state)
    msg.parse

    if msg.reply?
      @logger.info "Sent for repsonse #{email.subject}"
      @outgoing_mail << msg.response 
    else
      @logger.info "Not responding to #{email.subject}"
    end
  end
end

@threads << Thread.new do
  loop do
    email = @outgoing_mail.pop
    @logger.info "Sending email #{email[:subject]}"

    email[:from] ||= email_config[:user_name]

    begin
      Mailer.send(email)
    rescue Mailer::DeliveryError => e
      @logger.warn "Could not send #{email[:subject]}: #{e}"
    else
      @logger.info "Sent #{email[:subject]}"
    end
  end
end

@threads.each(&:join)
